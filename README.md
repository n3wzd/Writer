# Writer
사용자가 Markdown 형식의 텍스트를 작성하고 실시간으로 미리보기할 수 있는 웹 애플리케이션입니다.

![example](example.png)

- Markdown 텍스트 작성 가능
- 실시간 편집기, HTML 뷰어 업데이트
- 여러 텍스트 파일 저장 가능
- 텍스트 파일 생성, 폴더 생성, 이름 변경, 파일 삭제
- 텍스트 파일 MD 또는 HTML 파일로 저장하기
- MD, TEXT 파일 불러오기

## 기술 스택
- React

## 파일 구조
```
src/
│
├── components/: 재사용 가능한 컴포넌트
│   ├── icons.js: svg 아이콘 컴포넌트
│   └── menu-tab-button.js: 메뉴 탭 버튼
│
├── datas/: 클래스, 싱글톤, 상수
│   ├── class.js: 각종 클래스
│   ├── file-manaer.js: 파일을 관리하는 FileManager 싱글톤
│   ├── global-data.js: 전역 변수를 담은 GlobalData 싱글톤
│   └── markdown.js: Markdown 관련 상수
│
├── pages/: 레이아웃 UI 컴포넌트
│   ├── center.js: Center 레이아웃 UI
│   ├── left.js: Left 레이아웃 UI
│   └── right.js: Right 레이아웃 UI
│
├── styles/: 스타일시트
│   ├── editor.css: Markdown 편집기 스타일시트
│   ├── html.css: HTML 뷰어 스타일시트
│   ├── main.css: 전역 스타일시트
│   ├── pages-center.css: Center 컴포넌트 스타일시트
│   ├── pages-left.css: Left 컴포넌트 스타일시트
│   └── pages-right.css: Right 컴포넌트 스타일시트
│
├── utils/: 유틸리티 함수
│   ├── cursor.js: 커서 위치 탐색, 설정 함수
│   ├── editor.js: DOM 렌더링 엔진 알고리즘
│   ├── html.js: html 텍스트 파싱 함수
│   └── markdown.js: Markdown 트리 생성 알고리즘
│
├── App.js: 메인 레이아웃
└── index.js
```

### components
재사용 가능한 컴포넌트들을 포함합니다.

#### icons.js
svg 아이콘 컴포넌트들을 포함합니다.

#### menu-tab-button.js
UI 메뉴의 표시 유무를 토글하는 버튼 컴포넌트입니다. Left, Right 레이아웃에서 사용됩니다.

### datas
클래스, 싱글톤, 상수 등 데이터를 포함합니다.

#### class.js
각종 클래스들을 포함합니다.
- `MarkData`: Markdown에 대한 기본적인 데이터를 포함합니다.
- `MarkRange`: 범위가 있는 `MarkData`입니다. `MarkTreeNode` 구축에 활용됩니다.
- `MarkTreeNode`: Markdown 트리 노드로 활용되는 `MarkData`입니다.
- `TextPosition`: 텍스트에서 글자의 위치를 나타냅니다.
- `EditorState`: 텍스트 에디터의 상태를 나타냅니다. (현재 텍스트와 커서 위치)
- `RowState`: 텍스트에서 열의 상태를 나타냅니다. 자동 열 생성에서 활용됩니다.

#### file-manager.js
파일 및 디렉터리 간의 관계를 트리 구조로 관리하는 `FileManager` 싱글톤 클래스를 포함합니다.

- **파일 및 디렉터리 생성**: `createFile` 및 `createDirectory` 메서드를 사용하여 새로운 파일 및 디렉터리를 생성할 수 있습니다.
- **파일 및 디렉터리 조회**: `getFileById` 메서드를 사용하여 파일 또는 디렉터리를 고유 식별자(id)로 조회할 수 있습니다. (map 사용)
- **파일 및 디렉터리 수정**: `renameFile` 및 `updateFileText` 메서드를 사용하여 파일의 이름 및 내용을 수정할 수 있습니다.
- **파일 및 디렉터리 이동 및 삭제**: `moveFile` 메서드를 사용하여 파일 또는 디렉터리를 이동하거나, `deleteFile` 메서드를 사용하여 삭제할 수 있습니다.

#### global-data.js
전역 데이터를 관리하는 `GlobalData` 싱글톤 클래스를 포함합니다.

#### markdown.js
`MarkData` 상수 데이터를 포함합니다. (Markdown 패턴, 태그)

지원하는 태그는 다음과 같습니다:
- h1, h2, h3, h4, h5, h6, blockquote, hr
- del, strong, em, code, sup, sub
- ul, ol, table, img, a

### pages
애플리케이션의 각 페이지에 대한 컴포넌트들을 포함합니다.

#### center.js
레이아웃의 중심에 위치하는 컴포넌트 Center를 정의하며, 텍스트 편집 UI를 제공합니다. 편집기의 HTML 태그는 `<pre contentEditable=true/>`를 사용합니다.

- **편집기 DOM 업데이트**: 입력된 Markdown 텍스트를 기반으로 편집기의 DOM을 업데이트하고, 텍스트 마크업을 적용합니다.
	- 탭 문자 입력이 지원됩니다.
- **HTML 뷰어 업데이트**: 입력된 Markdown 텍스트를 HTML으로 실시간 변환하여 표시하는 컴포넌트를 포함합니다.
	- 패턴 문자는 감춰지며, 2개 이상 연속된 줄바꿈을 생략합니다.
- **커서 위치 표시**: 실시간으로 편집기 하단에 커서의 행과 열을 표시합니다.
- **Undo 또는 Redo**: `Ctrl + Z` 및 `Ctrl + Shift + Z` 키 조합을 사용하여 편집기 Undo 또는 Redo을 수행합니다.
	- 스택을 통해 `EditorState`를 관리됩니다.
	- 일정 시간동안 연속적인 입력이 발생하지 않을 때 `EditorState`이 새로 저장됩니다.

편집기 DOM의 동작 과정은 다음과 같습니다:
```
1. 입력 변화 감지
	- 입력 조합(insertCompositionText, 예: 한글)은 제외됩니다.
2. 현재 커서 위치 저장
3. 텍스트를 기반으로 Markdown 트리 생성
4. 이전 편집기 DOM, HTML 뷰어 DOM 초기화
5. MarkTree를 기반으로 편집기 DOM, HTML 뷰어 DOM 업데이트
	- 이전 커서 위치를 기반으로 편집기 DOM에서 커서 위치 설정
```

자동 패턴 입력 시스템을 지원합니다:
- 현재 행이 리스트, 인용문일 경우 발동됩니다.
- 현재 행에서 토큰 패턴(- , > , 1. ) 오른편에서 개행을 수행하면, 자동으로 다음 라인에 적절한 토큰 패턴을 삽입합니다.
	- 커서가 토큰 패턴 내부에 있는 경우는 위 효과가 실행되지 않습니다.
- 현재 라인에 토큰만 존재하는 상태에서 개행을 수행하면, 다음 라인을 추가하지 않고 현재 토큰을 지웁니다.
	- 커서가 토큰 패턴 내부에 있는 경우는 위 효과가 실행되지 않습니다.

에디터 DOM이 react의 useState이 아닌 DOM API를 사용하는 이유는 다음과 같습니다:
- 리렌더링이 발생하면 입력 상태(커서 위치 등)가 초기화됩니다.
- 리치 텍스트 에디터를 구현하려면 태그 추가가 필요합니다.

#### left.js
레이아웃의 왼쪽에 위치하는 컴포넌트 Left를 정의하며, `FileManager`와 연계되어 파일 및 디렉터리를 관리하는 UI 메뉴를 제공합니다.

- **메뉴 토글 기능**: 메뉴의 표시/비표시 상태를 전환합니다.
- **트리 구조**: 디렉터리와 파일을 트리 구조로 표시합니다.
- **디렉터리 펼치기/접기 기능**: 디렉터리를 펼치거나 접습니다.
- **파일/디렉터리 추가 기능**: 새 파일 또는 디렉터리를 현재 위치에 추가합니다.
- **파일/디렉터리 이름 변경 기능**: 파일 또는 디렉터리의 이름을 변경합니다.
- **파일/디렉터리 삭제 기능**: 파일 또는 디렉터리를 삭제합니다.
	- 디렉터리를 삭제하면 하위 파일도 모두 삭제됩니다.
- **파일/디렉터리 이동 기능**: 파일 또는 디렉터리를 드래그하여 원하는 위치로 이동합니다.
- **컨텍스트 메뉴 표시 기능**: 마우스 우클릭으로 파일 또는 폴더에 대한 컨텍스트 메뉴를 표시합니다.
	- 제공 기능: 파일 추가, 디렉터리 추가, 이름 변경, 삭제

#### right.js
레이아웃의 왼쪽에 위치하는 컴포넌트 Right를 정의하며, 로컬로 파일을 내보내거나 가져오는 UI 메뉴를 제공합니다.

- **메뉴 토글 기능**: 메뉴의 표시/비표시 상태를 전환합니다.
- **Markdown 파일 내보내기 기능**: 현재 편집 중인 Markdown 파일을 내보냅니다.
- **HTML 파일 내보내기 기능**: 현재 편집 중인 Markdown 파일을 HTML 파일로 변환하여 내보냅니다.
	- 특정 태그에서 자동으로 개행이 발생합니다.
	- 자동으로 html, head 등 메타 태그가 추가됩니다.
	- title 태그 내용은 이스케이프 처리되어 XSS 공격에 대비합니다.
- **Markdown 파일 가져오기 기능**: 사용자가 선택한 Markdown 파일을 가져옵니다. (txt, md 파일 지원)

### styles
스타일시트를 포함합니다.

#### editor.css
Markdown 편집기에서 사용되는 스타일시트입니다.

#### html.css
HTML 뷰어에서 사용되는 스타일시트입니다.

#### main.css
전역에서 사용되는 스타일시트입니다.

#### pages-center.css
`Center` 컴포넌트에서 사용되는 스타일시트입니다.

#### pages-left.css
`Left` 컴포넌트에서 사용되는 스타일시트입니다.

#### pages-right.css
`Right` 컴포넌트에서 사용되는 스타일시트입니다.

### utils
여러 곳에서 사용될 수 있는 유틸리티 함수들을 포함합니다.

#### cursor.js
커서 위치를 가져오고 설정하는 API를 제공합니다. Web API의 selection과 range를 활용합니다.

- `getCursorPosition`: 편집기 DOM 노드와 텍스트를 기반으로 현재 커서의 위치(행, 열, 오프셋)를 계산합니다.
	- 오프셋: 텍스트 시작부터 현재 위치까지 거리
	- 드래그 선택시, 선택된 범위의 시작점을 기준으로 합니다.
- `setCursorPosition`: 특정 노드와 오프셋을 기반으로 커서의 위치를 설정합니다.

커서 위치 탐색 과정은 다음과 같습니다:
```
1. 임시 노드를 기반으로 현재 행을 찾습니다.
	1. 현재 위치에 임시 텍스트 노드를 삽입합니다.
	2. 행의 길이가 달라진 곳이 현재 행입니다.
	3. 임시 노드를 삭제합니다.
2. 현재 오프셋을 찾습니다.
	1. 임시 range를 생성합니다.
	2. 임시 range의 시작을 텍스트의 시작, 끝을 현재 커서의 위치로 합니다.
	3. 임시 range의 길이를 구합니다.
3. 현재 행과 오프셋을 기반으로 현재 열을 찾습니다.
	- 현재 오프셋에서 아래 행들의 길이를 빼서 구할 수 있습니다.
```

#### editor.js
텍스트 편집기, HTML 뷰어의 렌더링 엔진에서 사용되는 API를 제공합니다.

- `applyMarkTreeToEditorDOM`: 텍스트와 Markdown 트리를 기반으로 텍스트 에디터의 DOM을 구축합니다.
	- Markdown 트리를 순회하면서 `MarkTreeNode`를 기반으로 DOM 노드를 추가합니다.
	- 커서의 위치를 찾아 설정합니다.
- `applyMarkTreeToHTMLDOM`: 텍스트와 Markdown 트리를 기반으로 HTML 뷰어의 DOM을 구축합니다.
	- Markdown 트리를 순회하면서 `MarkTreeNode`를 기반으로 DOM 노드를 추가합니다.
- `deleteDOMChildren`: 주어진 HTML 노드를 자식 노드 포함하여 모두 삭제합니다.

#### html.js
텍스트 처리를 위한 유틸리티 API를 제공합니다.

- `compatibleLineBreak`: 텍스트 내의 줄 바꿈 문자를 호환 가능한 형식으로 변환합니다.
	- pre 태그의 innerText를 사용 가능한 텍스트로 가공할 때 사용됩니다.
- `getLineLengthByRow`: 특정 행의 길이를 반환합니다.
- `escapeHtml`: HTML 특수 문자를 이스케이프합니다.
	- 주어진 텍스트에서 HTML 특수 문자를 해당하는 HTML 엔티티로 대체합니다.

`compatibleLineBreak`의 동작 과정은 다음과 같습니다:
```
1. 텍스트에서 줄 바꿈 문자의 개수를 세고, 홀수 개의 경우 마지막 줄 바꿈 문자를 제거합니다.
2. 연속된 두 개 이상의 줄 바꿈 문자를 하나의 줄 바꿈 문자로 대체합니다.
```

#### markdown.js
텍스트를 기반으로 Markdown 트리를 생성하는 API를 제공합니다.

- `createMarkTree`: 주어진 텍스트를 기반으로 Markdown 트리를 생성합니다.
- `linkMarkTree`: 생성된 MarkData 리스트를 바탕으로 Markdown 트리를 연결합니다.

`createMarkTree`의 동작 과정은 다음과 같습니다:
```
1. 텍스트를 줄 단위로 분할합니다.
2. 전체 텍스트를 대상으로 패턴을 검색합니다.
	- 큰 코드 블록, 리스트, 테이블 패턴
3. 줄 단위로 나머지 패턴들을 검색합니다.
	- 수직선, 제목, 인용문 패턴
	- 이미지, 링크 패턴
	- 볼드체, 이탤릭체, 취소선 등 패턴
4. 단락 패턴을 생성합니다.
5. 검색된 패턴들을 위치 기준으로 오름차순 정렬합니다.
6. 검색된 패턴 리스트를 기반으로 Markdown 트리를 생성하고 반환합니다.
```

`linkMarkTree`의 동작 과정은 다음과 같습니다:
```
1. Markdown 트리의 루트 노드를 생성합니다.
2. MarkRange 리스트를 순서대로 탐색하여 Markdown 트리를 구축하고 연결합니다.
```

##### scanLargeCodeBlock
큰 코드 블록 패턴을 검색합니다.

```
1. 텍스트 전체 스캔:
	- 모든 행을 순회하여 코드 블록 패턴을 스캔하고 처리합니다.
2. 패턴 검사:
	- 코드 블록의 시작과 끝을 식별하고, 탐색 결과를 결과 리스트에 반영합니다.
	- 코드 블록 내에서는 모든 태그 효과가 무시됩니다.
```

##### scanListPattern
순서 있는 리스트와 순서 없는 리스트 패턴을 검색합니다.

```
1. 텍스트 전체 스캔:
	- 모든 행을 순회하여 리스트 패턴을 스캔하고 처리합니다.
2. 중첩된 리스트 처리:
	- 중첩된 리스트를 처리하기 위해 깊이를 기준으로 패턴 검사를 재귀적으로 수행합니다.
	- 리스트 깊이는 탭 문자로 구분합니다.
3. 패턴 검사:
	- 리스트 유형, 깊이를 기준으로 각 행의 리스트 패턴(li)을 식별합니다.
		- 순서 있는 리스트(ol)일 경우, 순서도 고려합니다.
	- 패턴이 불일치할 때까지 탐색하여, 리스트(ol, ul)가 시작되는 행부터 종료되는 행까지의 범위를 결정합니다.
	- 탐색 결과를 결과 리스트에 반영하고, 현재 리스트 탐색을 종료합니다.
```

##### scanTablePattern
테이블 패턴을 검색합니다. 테이블의 각 행과 열을 인식하여 해당 부분을 특정 마크 데이터로 표시합니다.

"|"를 기준으로 td를 구분하며, 기준 라인(|---|)을 중점으로 데이터를 파싱합니다.

```
1. 텍스트 전체 스캔:
	- 모든 행을 순회하여 테이블 패턴을 스캔하고 처리합니다.
2. 패턴 검사:
	- 중심 라인("|---|")을 기준으로 테이블 탐색 시작점를 판단합니다.
	- 중심 라인을 기준으로 제목 영역(thead)과 내용 영역(tbody)을 탐색합니다.
	- 제목 영역은 1개의 행, 내용 영역은 여러 개의 행을 가집니다.
	- "|"를 기준으로 테이블 열을 구분하며, 모든 테이블 행은 열 개수가 모두 같아야 합니다.
	- 조건에 맞다면 탐색 결과를 결과 리스트에 반영합니다.
```

##### scanDoublePatternInLine
텍스트 한 줄 내에서 쌍 구조 패턴(볼드체, 이탤릭체 등)과 주석 패턴을 검색합니다.

- 텍스트를 순차 탐색하여, 검색된 패턴을 스택으로 관리합니다.
- 겹쳐지는 패턴은 무시됩니다.
- 코드 블록 내부에는 다른 패턴을 적용하지 않습니다.

##### scanOnlyLinePatternInLine
텍스트 한 줄 내에서 수직선 패턴을 검색합니다.

##### scanSinglePatternInLine
텍스트 한 줄 내에서 제목, 인용문 패턴을 검색합니다.

##### scanImagePatternInLine
텍스트 한 줄 내에서 이미지 패턴을 검색합니다.

- 정규 표현식을 사용하여 패턴을 스캔합니다.
- 데이터를 HTML 속성에 반영합니다.

##### scanLinkPatternInLine
텍스트 한 줄 내에서 링크 패턴을 검색합니다.

- 정규 표현식을 사용하여 패턴을 스캔합니다.
- 데이터를 HTML 속성에 반영합니다.

##### scanParagraphPattern
HTML 뷰어에서 사용되는 단락 패턴을 생성합니다.

단락 패턴의 생성 규칙은 다음과 같습니다:
- 일반적인 텍스트는 단락으로 취급되며, 단락은 p 태그에 포함됩니다.
	- 제목, 인용문, 테이블 등 일부 패턴은 단락이 아닙니다.
- 단락 내에서 단일 줄바꿈은 br 태그로 대체됩니다.
- 2개 이상 연속된 줄바꿈은 단락을 분할합니다.
